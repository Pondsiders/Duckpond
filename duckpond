#!/bin/bash
# Launch Duckpond (backend + frontend)

cd /Volumes/Pondside/Barn/Duckpond

# Kill both processes on exit
trap 'kill 0' EXIT

# Figure out what URL to advertise
CERT_DIR="/Volumes/Pondside/Basement/Files/certs"
TAILSCALE_HOST=$(tailscale status --json 2>/dev/null | python3 -c "import json,sys; print(json.load(sys.stdin)['Self']['DNSName'].rstrip('.'))" 2>/dev/null)

if [[ -n "$TAILSCALE_HOST" && -f "$CERT_DIR/$TAILSCALE_HOST.crt" ]]; then
    FRONTEND_URL="https://${TAILSCALE_HOST}:8766"
else
    FRONTEND_URL="http://localhost:8766"
fi

echo "ðŸ¦† Starting Duckpond..."
echo "   Backend:  http://localhost:8765"
echo "   Frontend: $FRONTEND_URL"
echo ""

# Backend runs WITHOUT hot-reload (dev:stable) to prevent mid-conversation disconnects
# Frontend runs WITH hot-reload (dev) since UI changes are harmless
(cd backend && npm run dev:stable) &
(cd frontend && npm run dev) &

wait
